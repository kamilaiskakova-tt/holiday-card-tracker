<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Holiday Card Signature Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f7;
            min-height: 100vh;
        }
        .card-container {
            background-color: white;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s;
        }
        .card-container:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 10px rgba(0, 0, 0, 0.15);
        }
        .status-signed {
            background-color: #10b981; /* Emerald Green */
            color: white;
        }
        .status-pending {
            background-color: #f59e0b; /* Amber */
            color: white;
        }
    </style>
</head>
<body class="p-4 sm:p-8">

    <!-- Header Section -->
    <header class="max-w-4xl mx-auto mb-8 text-center">
        <h1 class="text-4xl font-bold text-gray-800 mb-2">Holiday Card Signature Tracker</h1>
        <p class="text-lg text-gray-600">Enter your company email to see your pending tasks.</p>
    </header>

    <!-- Email Input and Filter -->
    <div class="max-w-2xl mx-auto bg-white p-6 rounded-xl shadow-lg mb-8">
        <label for="signerEmail" class="block text-sm font-medium text-gray-700 mb-2">Your Company Email (Signer Email)</label>
        <div class="flex flex-col sm:flex-row gap-3">
            <input type="email" id="signerEmail" placeholder="e.g., dani@company.com" class="flex-grow p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 text-base" value="">
            <button onclick="loadAndFilterCards()" class="bg-indigo-600 text-white p-3 rounded-lg font-semibold hover:bg-indigo-700 transition duration-150 shadow-md">
                Show My Cards
            </button>
        </div>
    </div>

    <!-- Message Box for Feedback -->
    <div id="messageBox" class="max-w-4xl mx-auto p-4 hidden rounded-lg shadow-md text-sm transition-opacity duration-300" role="alert"></div>

    <!-- Card List Container -->
    <main id="cardList" class="max-w-4xl mx-auto grid grid-cols-1 gap-6"></main>

    <!-- Template for a Single Card -->
    <template id="cardTemplate">
        <div class="card-container flex flex-col md:flex-row justify-between items-start md:items-center">
            <div class="flex-grow w-full md:w-auto mb-4 md:mb-0">
                <div class="flex items-center space-x-3 mb-2">
                    <span class="font-bold text-xl text-gray-900" data-field="Card Receiver Name"></span>
                    <span class="px-3 py-1 text-xs font-semibold rounded-full uppercase" data-field="Signature Status" id="statusBadge"></span>
                </div>
                
                <div class="grid grid-cols-2 gap-x-6 gap-y-1 text-sm text-gray-500">
                    <p><span class="font-medium text-gray-700">Type:</span> <span data-field="Recipient Type"></span></p>
                    <p><span class="font-medium text-gray-700">Study:</span> <span data-field="Study"></span></p>
                    <p><span class="font-medium text-gray-700">Lead:</span> <span data-field="Project Lead"></span></p>
                    <p><span class="font-medium text-gray-700">Card Maker:</span> <span data-field="Card Maker"></span></p>
                    <p class="col-span-2"><span class="font-medium text-gray-700">Receiver Email:</span> <span data-field="Receiver Email"></span></p>
                    <p class="col-span-2 text-xs italic" id="dateSignedDisplay"></p>
                </div>
            </div>

            <div class="flex flex-col space-y-3 w-full md:w-auto">
                <a href="#" target="_blank" class="text-center font-semibold text-white p-3 rounded-lg bg-blue-600 hover:bg-blue-700 transition duration-150 shadow-md" id="signCardButton">
                    1. Redirect to Sign Card
                </a>
                <button type="button" class="text-center font-semibold text-white p-3 rounded-lg bg-emerald-600 hover:bg-emerald-700 transition duration-150 shadow-md" id="markSignedButton">
                    2. Mark as Signed (Opens Form)
                </button>
            </div>
        </div>
    </template>

    <script>
        // =========================================================================================
        // === Configuration: REPLACE THESE PLACEHOLDER VALUES WITH YOUR ACTUAL GOOGLE LINKS ===
        // =========================================================================================

        // --- SECURITY CONFIGURATION ---
        // ðŸš¨ IMPORTANT: List all allowed email domains (MUST start with '@')
        // Only emails ending with these domains will be able to proceed past the filtering stage.
        const ALLOWED_DOMAINS = [
            "@trulab.com", // Example Company 1
            "@tru.team", // Example Company 2
            // Add all domains that are allowed to sign cards here.
        ];


        // 1. Google Sheets Publish Link (Must be published to the web: File -> Share -> Publish to web)
        // This is the URL structure for fetching data from your published sheet using the Visualization API.
        const SHEET_ID = '1rqwQqJjokX_6W8sEZhQRuxZVWmuSMYlVfrRzYQjjFEI'; // <-- Sheet ID extracted from your previous URL
        const TAB_ID = 'https://docs.google.com/spreadsheets/d/1rqwQqJjokX_6W8sEZhQRuxZVWmuSMYlVfrRzYQjjFEI/edit?gid=659414623#gid=659414623';     // <-- CRITICAL: REPLACE this with the GID (e.g., 0 for the first tab, or a long number) of your Signatures Tracker tab.
        // The script automatically constructs the correct Visualization API URL below:
        const GOOGLE_SHEET_DATA_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&gid=${TAB_ID}`;


        // 2. Google Form Pre-filled Submission URL
        // This is the base URL of the Google Form you created to record the status update.
        const FORM_URL = 'YOUR_PREFILLED_GOOGLE_FORM_URL_HERE'; // Example: https://docs.google.com/forms/d/e/FORM_ID/viewform
        
        // Example entry IDs (you must find these in your prefilled link URL):
        const SIGNER_EMAIL_ENTRY_ID = 'entry.1234567890'; // e.g., entry.1234567890 (Replace with your Form's entry ID for Signer Email)
        const RECEIVER_NAME_ENTRY_ID = 'entry.0987654321'; // e.g., entry.0987654321 (Replace with your Form's entry ID for Card Receiver Name)
        const STATUS_SIGNED_ENTRY_ID = 'entry.5432109876'; // e.g., entry.5432109876 (Replace with your Form's entry ID for Signature Status)
        const STATUS_SIGNED_VALUE = 'Signed'; // The exact text you used to pre-fill the Status field

        // =========================================================================================

        const cardListElement = document.getElementById('cardList');
        const messageBox = document.getElementById('messageBox');
        let cardData = [];

        // Function to display messages (success/error)
        function showMessage(message, isError = false) {
            messageBox.textContent = message;
            messageBox.classList.remove('hidden', 'bg-red-100', 'text-red-800', 'bg-green-100', 'text-green-800');
            messageBox.classList.add(isError ? 'bg-red-100' : 'bg-green-100', isError ? 'text-red-800' : 'text-red-800');
            if (isError) {
                // Clear the card list on error
                cardListElement.innerHTML = '';
            }
        }
        
        // Security check: Verify if the email domain is allowed
        function isDomainAllowed(email) {
            const lowerEmail = email.toLowerCase();
            return ALLOWED_DOMAINS.some(domain => lowerEmail.endsWith(domain.toLowerCase()));
        }

        // Function to load data from the published Google Sheet
        async function fetchCardData() {
            showMessage("Loading data from Google Sheet...", false);
            try {
                // The Google Sheets API returns JSON wrapped in a weird format. We clean it up.
                const response = await fetch(GOOGLE_SHEET_DATA_URL);
                if (!response.ok) {
                    // Update error message to guide the user on the 404 fix
                    throw new Error(`HTTP error! status: ${response.status}. Check the console for details. 
                        Ensure the Google Sheet is published to the web (File -> Share -> Publish to web), and 
                        the TAB_ID (GID) in the script is correct.`);
                }
                const text = await response.text();
                // Clean the response text to extract pure JSON
                const jsonText = text.substring(text.indexOf('{'), text.lastIndexOf('}') + 1);
                const data = JSON.parse(jsonText);

                // Extract headers and rows
                const cols = data.table.cols.map(col => col.label).filter(label => label); // Get non-empty headers
                const rows = data.table.rows.map(row => {
                    const obj = {};
                    row.c.forEach((cell, index) => {
                        if (cell) {
                            // Use the label from the header (cols[index])
                            obj[cols[index]] = cell.v || cell.f || (cell.v === 0 ? 0 : '');
                        }
                    });
                    return obj;
                });
                
                cardData = rows;
                showMessage(`Successfully loaded ${cardData.length} total records.`, false);
                return cardData;

            } catch (error) {
                console.error("Error fetching data:", error);
                showMessage(`Error loading data: ${error.message}`, true);
                return [];
            }
        }

        // Function to filter and render cards
        function renderCards(data) {
            cardListElement.innerHTML = '';
            const email = document.getElementById('signerEmail').value.trim().toLowerCase();
            let filteredCards;

            if (!email) {
                showMessage("Please enter your email address to filter your cards.", true);
                return;
            }

            // --- FILTERING AND SECURITY CHECK ---
            if (!isDomainAllowed(email)) {
                showMessage(`Access denied. The email domain for ${email} is not authorized to use this portal.`, true);
                return;
            }
            // ------------------------------------

            // Filter data based on Signer Email
            filteredCards = data.filter(card => 
                card['Signer Email'] && card['Signer Email'].toLowerCase() === email
            );

            if (filteredCards.length === 0) {
                showMessage(`No pending or signed cards found for: ${email}.`, true);
                return;
            }

            // Sort to show pending cards first
            filteredCards.sort((a, b) => {
                const statusA = a['Signature Status'] ? a['Signature Status'].toLowerCase() : '';
                const statusB = b['Signature Status'] ? b['Signature Status'].toLowerCase() : '';
                if (statusA === 'pending' && statusB !== 'pending') return -1;
                if (statusA !== 'pending' && statusB === 'pending') return 1;
                return 0;
            });
            
            // Render the filtered cards
            const template = document.getElementById('cardTemplate');
            filteredCards.forEach(card => {
                const cardClone = template.content.cloneNode(true);
                const cardDiv = cardClone.querySelector('.card-container');
                
                // Map all fields
                for (const key in card) {
                    const element = cardDiv.querySelector(`[data-field="${key}"]`);
                    if (element) {
                        element.textContent = card[key] || 'N/A';
                    }
                }

                // Status Badge styling
                const status = card['Signature Status'] ? card['Signature Status'].toLowerCase() : 'pending';
                const statusBadge = cardDiv.querySelector('#statusBadge');
                statusBadge.classList.remove('status-signed', 'status-pending');
                statusBadge.classList.add(status === 'signed' ? 'status-signed' : 'status-pending');
                
                // Date Signed display
                const dateSignedDisplay = cardDiv.querySelector('#dateSignedDisplay');
                if (card['Date Signed']) {
                    dateSignedDisplay.textContent = `Signed on: ${card['Date Signed']}`;
                } else {
                    dateSignedDisplay.textContent = 'Awaiting signature.';
                }

                // Button logic (Link to Card)
                const signCardButton = cardDiv.querySelector('#signCardButton');
                signCardButton.href = card['Card Link'] || '#';
                signCardButton.target = "_blank"; // Always open card link in new tab

                // Button logic (Mark as Signed)
                const markSignedButton = cardDiv.querySelector('#markSignedButton');

                if (status === 'signed') {
                    // Disable and hide mark signed button if already signed
                    markSignedButton.disabled = true;
                    markSignedButton.textContent = 'Signed!';
                    markSignedButton.classList.remove('bg-emerald-600', 'hover:bg-emerald-700');
                    markSignedButton.classList.add('bg-gray-400', 'cursor-not-allowed');
                } else {
                    // Attach the dynamic form link to the button
                    markSignedButton.onclick = () => {
                        const prefilledLink = `${FORM_URL}&${SIGNER_EMAIL_ENTRY_ID}=${encodeURIComponent(card['Signer Email'])}&${RECEIVER_NAME_ENTRY_ID}=${encodeURIComponent(card['Card Receiver Name'])}&${STATUS_SIGNED_ENTRY_ID}=${encodeURIComponent(STATUS_SIGNED_VALUE)}`;
                        window.open(prefilledLink, '_blank');
                        // Optional: Show message to remind user to refresh after submitting form
                        showMessage("Form opened in a new tab. Please submit the form and then click 'Show My Cards' here to refresh the status.", false);
                    };
                }
                
                cardListElement.appendChild(cardClone);
            });

            showMessage(`Found ${filteredCards.length} tasks for ${email}. Pending: ${filteredCards.filter(c => c['Signature Status'].toLowerCase() === 'pending').length}`, false);
        }

        // Master function to trigger data fetch and rendering
        async function loadAndFilterCards() {
            const email = document.getElementById('signerEmail').value.trim().toLowerCase();
            
            // Check domain security before fetching/rendering
            if (!email) {
                showMessage("Please enter your email address.", true);
                return;
            }
            if (!isDomainAllowed(email)) {
                showMessage(`Access denied. The email domain for ${email} is not authorized to use this portal.`, true);
                return;
            }

            if (cardData.length === 0) {
                cardData = await fetchCardData();
            }
            if (cardData.length > 0) {
                renderCards(cardData);
            }
        }
        
        // Initial load check (optional, but good practice)
        document.addEventListener('DOMContentLoaded', () => {
             // You can optionally auto-run loadAndFilterCards() here if you set a default email
             // document.getElementById('signerEmail').value = 'dani@company.com'; 
             // loadAndFilterCards();
        });

    </script>
</body>
</html>
